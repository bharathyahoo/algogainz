name: Load Tests

on:
  # Run weekly on Mondays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of load test to run'
        required: true
        default: 'trading'
        type: choice
        options:
          - quick
          - trading
          - auth
          - watchlist
          - all

      api_url:
        description: 'API Base URL'
        required: false
        default: 'https://staging-api.algogainz.com'

  # Run on pull requests to main (optional)
  # pull_request:
  #   branches:
  #     - main
  #   paths:
  #     - 'backend/**'

jobs:
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Verify k6 installation
        run: k6 version

      - name: Run Quick Baseline Test
        if: github.event.inputs.test_type == 'quick' || github.event.inputs.test_type == ''
        env:
          API_BASE_URL: ${{ github.event.inputs.api_url || secrets.STAGING_API_URL || 'https://staging-api.algogainz.com' }}
        run: |
          echo "Running quick baseline test against $API_BASE_URL"
          k6 run --vus 20 --duration 1m --env API_BASE_URL="$API_BASE_URL" load-tests/trading-api.js

      - name: Run Trading API Load Test
        if: github.event.inputs.test_type == 'trading' || github.event.inputs.test_type == 'all'
        env:
          API_BASE_URL: ${{ github.event.inputs.api_url || secrets.STAGING_API_URL }}
        run: |
          echo "Running trading API load test"
          k6 run --out json=results-trading.json --env API_BASE_URL="$API_BASE_URL" load-tests/trading-api.js

      - name: Run Authentication Load Test
        if: github.event.inputs.test_type == 'auth' || github.event.inputs.test_type == 'all'
        env:
          API_BASE_URL: ${{ github.event.inputs.api_url || secrets.STAGING_API_URL }}
        run: |
          echo "Running authentication load test"
          k6 run --out json=results-auth.json --env API_BASE_URL="$API_BASE_URL" load-tests/authentication.js

      - name: Run Watchlist Load Test
        if: github.event.inputs.test_type == 'watchlist' || github.event.inputs.test_type == 'all'
        env:
          API_BASE_URL: ${{ github.event.inputs.api_url || secrets.STAGING_API_URL }}
        run: |
          echo "Running watchlist load test"
          k6 run --out json=results-watchlist.json --env API_BASE_URL="$API_BASE_URL" load-tests/watchlist.js

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: results-*.json
          retention-days: 30

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ“Š Load Test Results\n\n';

            // Read and parse results (simplified example)
            const files = ['results-trading.json', 'results-auth.json', 'results-watchlist.json'];

            for (const file of files) {
              if (fs.existsSync(file)) {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                const testName = file.replace('results-', '').replace('.json', '');

                comment += `### ${testName.toUpperCase()}\n`;
                comment += `- **Requests**: ${data.metrics.http_reqs?.values?.count || 'N/A'}\n`;
                comment += `- **Duration (avg)**: ${data.metrics.http_req_duration?.values?.avg?.toFixed(2) || 'N/A'}ms\n`;
                comment += `- **Failed**: ${((data.metrics.http_req_failed?.values?.rate || 0) * 100).toFixed(2)}%\n\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail job if error rate is too high
        if: always()
        run: |
          # Check if any test had > 5% error rate
          # This is a simplified check - you can make it more sophisticated

          if [ -f results-trading.json ]; then
            echo "Checking error rates..."
            # Add logic to parse JSON and check error rates
            # Example: jq '.metrics.http_req_failed.values.rate' results-trading.json
          fi

  # Optional: Send notifications
  notify:
    needs: load-test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Slack notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Load tests failed! Check the workflow run for details.'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Send email notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'AlgoGainz Load Tests Failed'
          to: ${{ secrets.ALERT_EMAIL }}
          from: 'AlgoGainz CI/CD'
          body: 'Load testing workflow failed. Check GitHub Actions for details.'
